<div *ngIf="diet() as d" class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="text-success mb-0">{{ d.title }}</h3>
      <p class="text-muted">{{ d.description }}</p>
    </div>
    <div>
      <button
        class="btn btn-warning btn-sm me-2"
        (click)="isEditing = true"
        *ngIf="!isEditing"
      >
        <i class="bi bi-pencil"></i> Edit
      </button>
      <button
        class="btn btn-secondary btn-sm me-2"
        (click)="isEditing = false"
        *ngIf="isEditing"
      >
        Cancel
      </button>
      <button class="btn btn-danger btn-sm" (click)="deleteDiet()">
        <i class="bi bi-trash"></i> Delete
      </button>
    </div>
  </div>

  <form *ngIf="isEditing" (ngSubmit)="saveDiet()">
    <div class="mb-3">
      <label class="form-label">Title</label>
      <input class="form-control" [(ngModel)]="d.title" name="title" required />
    </div>
    <div class="mb-3">
      <label class="form-label">Description</label>
      <textarea
        class="form-control"
        [(ngModel)]="d.description"
        name="description"
      ></textarea>
    </div>
    <div class="mb-3">
      <label class="form-label">Duration (weeks)</label>
      <input
        type="number"
        class="form-control"
        [(ngModel)]="d.durationInWeeks"
        name="durationInWeeks"
        required
      />
    </div>

    <div
      *ngFor="let meal of d.mealTypes?.$values; let i = index"
      class="border rounded p-3 mb-3"
    >
      <h6>Meal {{ i + 1 }}: {{ meal.mealType }}</h6>
      <input
        class="form-control mb-2"
        [(ngModel)]="meal.mealName"
        name="mealName{{i}}"
      />
      <div class="row">
        <div class="col">
          <label>Calories</label>
          <input
            class="form-control"
            type="number"
            [(ngModel)]="meal.calories"
            name="calories{{i}}"
          />
        </div>
        <div class="col">
          <label>Protein (g)</label>
          <input
            class="form-control"
            type="number"
            [(ngModel)]="meal.proteinGrams"
            name="protein{{i}}"
          />
        </div>
        <div class="col">
          <label>Carbs (g)</label>
          <input
            class="form-control"
            type="number"
            [(ngModel)]="meal.carbsGrams"
            name="carbs{{i}}"
          />
        </div>
        <div class="col">
          <label>Fats (g)</label>
          <input
            class="form-control"
            type="number"
            [(ngModel)]="meal.fatGrams"
            name="fat{{i}}"
          />
        </div>
      </div>
    </div>

    <button class="btn btn-success mt-3" type="submit">Save Changes</button>
  </form>

  <div *ngIf="!isEditing">
    <p><strong>Duration:</strong> {{ d.durationInWeeks }} weeks</p>

    <h5 class="mt-4">Meal Plan</h5>
    <ul class="list-group">
      <li
        *ngFor="let meal of d.mealTypes?.$values"
        class="list-group-item d-flex justify-content-between align-items-start"
      >
        <div>
          <strong>{{ meal.mealType }}</strong>
          <p class="mb-1">{{ meal.mealName }}</p>
        </div>
        <div class="text-end small">
          <div class="text-muted">Calories: {{ meal.calories }}</div>
          <span class="badge bg-success me-1"
            >{{ meal.proteinGrams }}g Protein</span
          >
          <span class="badge bg-warning text-dark me-1"
            >{{ meal.carbsGrams }}g Carbs</span
          >
          <span class="badge bg-info text-dark">{{ meal.fatGrams }}g Fat</span>
        </div>
      </li>
    </ul>
    <div class="mb-4">
      <label class="form-label">Assigned Users</label>
      <ul class="list-group">
        <!-- <pre>{{w.clients|json}}</pre> -->
        <li
          *ngFor="let user of d.clients?.$values"
          class="list-group-item d-flex justify-content-between align-items-center"
        >
          <div>
            <strong>{{ user.name }}</strong>
            <span class="text-muted small ms-2">{{ user.email }}</span>
          </div>

          <div class="text-end">
            <div>
              <span class="badge bg-light text-dark">
                Assigned on: {{ user.assignedOn | date:'mediumDate' }}
              </span>
            </div>
            <div>
              <span
                class="badge"
                [ngClass]="{
                'bg-success': user.status === 'Completed',
                'bg-warning': user.status === 'Not Completed',
                'bg-danger': user.status === 'inactive'
              }"
              >
                {{ user.status }}
              </span>
            </div>
          </div>
        </li>
        <li
          *ngIf="!d.clients?.$values?.length"
          class="list-group-item text-muted"
        >
          No users assigned.
        </li>
      </ul>
    </div>
  </div>
</div>

<div *ngIf="!diet()" class="text-center text-muted mt-5">
  <p>Loading diet plan...</p>
</div>
